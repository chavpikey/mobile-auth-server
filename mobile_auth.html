<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ“± ç§»åŠ¨æˆæƒç®¡ç†</title>
    
    <!-- PWAæ”¯æŒ -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æˆæƒç®¡ç†">
    
    <style>
        /* iOS Safariä¼˜åŒ–æ ·å¼ */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            margin: 0;
            padding: 0;
            background: #f2f2f7;
            color: #1c1c1e;
            overflow-x: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #C1272D 0%, #FF6B35 100%);
            color: white;
            padding: 20px 20px 30px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }
        
        .status {
            margin-top: 10px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .container {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .request-card {
            background: white;
            border-radius: 16px;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e5e5ea;
            transition: transform 0.2s ease;
        }
        
        .request-card:active {
            transform: scale(0.98);
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .machine-code {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 14px;
            font-weight: 600;
            color: #C1272D;
            background: #fff2f0;
            padding: 8px 12px;
            border-radius: 8px;
            flex: 1;
            margin-right: 10px;
            word-break: break-all;
        }
        
        .time-badge {
            background: #007aff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .request-info {
            margin-bottom: 20px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info-label {
            color: #8e8e93;
            font-weight: 500;
        }
        
        .info-value {
            color: #1c1c1e;
            font-weight: 600;
            text-align: right;
            max-width: 60%;
            word-break: break-all;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            flex: 1;
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-approve {
            background: #34c759;
            color: white;
        }
        
        .btn-approve:hover {
            background: #30d158;
        }
        
        .btn-reject {
            background: #ff3b30;
            color: white;
        }
        
        .btn-reject:hover {
            background: #ff453a;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .loading {
            position: relative;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8e8e93;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .refresh-btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: background 0.2s ease;
        }
        
        .refresh-btn:hover {
            background: #0056cc;
        }
        
        .refresh-btn:active {
            transform: scale(0.95);
        }
        
        .expire-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .expire-option {
            background: #f2f2f7;
            color: #1c1c1e;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .expire-option.active {
            background: #007aff;
            color: white;
        }
        
        .expire-option:active {
            transform: scale(0.95);
        }
        
        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        /* å“åº”å¼é€‚é… */
        @media (max-width: 375px) {
            .container {
                padding: 15px;
            }
            
            .request-card {
                padding: 16px;
            }
            
            .machine-code {
                font-size: 12px;
            }
        }
        
        /* æ·±è‰²æ¨¡å¼æ”¯æŒ */
        @media (prefers-color-scheme: dark) {
            body {
                background: #000000;
                color: #ffffff;
            }
            
            .request-card {
                background: #1c1c1e;
                border-color: #38383a;
            }
            
            .machine-code {
                background: #2c1810;
                color: #ff6b47;
            }
            
            .info-label {
                color: #98989d;
            }
            
            .info-value {
                color: #ffffff;
            }
            
            .expire-option {
                background: #2c2c2e;
                color: #ffffff;
            }
            
            .empty-state {
                color: #98989d;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“± ç§»åŠ¨æˆæƒç®¡ç†</h1>
        <div class="status" id="statusText">æ­£åœ¨åŠ è½½...</div>
    </div>
    
    <div class="container">
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="refresh-btn" onclick="loadRequests()" style="flex: 1;">ğŸ”„ åˆ·æ–°è¯·æ±‚</button>
            <button class="refresh-btn" onclick="forceSync()" style="flex: 1; background: #ff9500;">ğŸ”„ å¼ºåˆ¶åŒæ­¥</button>
            <button class="refresh-btn" onclick="showDebugInfo()" style="flex: 1; background: #9c27b0; font-size: 12px;">ğŸ”§ è°ƒè¯•</button>
        </div>
        
        <div id="requestList">
            <!-- è¯·æ±‚åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">ğŸ“­</div>
            <p>æš‚æ— å¾…å¤„ç†çš„æˆæƒè¯·æ±‚</p>
            <p>å¦‚æœæ¡Œé¢ç‰ˆåˆšå¤„ç†è¿‡è¯·æ±‚ï¼Œè¯·ç‚¹å‡»"å¼ºåˆ¶åŒæ­¥"æŒ‰é’®</p>
            <p>ç³»ç»Ÿæ¯30ç§’è‡ªåŠ¨åˆ·æ–°</p>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>
    
    <script>
        let selectedExpireHours = 720; // é»˜è®¤30å¤©
        let isLoading = false;
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeStr) {
            try {
                const date = new Date(timeStr);
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                
                if (minutes < 1) return 'åˆšåˆš';
                if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
                
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours}å°æ—¶å‰`;
                
                const days = Math.floor(hours / 24);
                return `${days}å¤©å‰`;
            } catch {
                return timeStr;
            }
        }
        
        // åŠ è½½è¯·æ±‚åˆ—è¡¨
        async function loadRequests() {
            if (isLoading) return;
            
            isLoading = true;
            document.getElementById('statusText').textContent = 'æ­£åœ¨åŠ è½½è¯·æ±‚...';
            
            // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ç§’è¶…æ—¶
            
            try {
                const response = await fetch('/api/requests', {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayRequests(result.data);
                    document.getElementById('statusText').textContent = 
                        `å…± ${result.data.length} ä¸ªå¾…å¤„ç†è¯·æ±‚ | ${new Date().toLocaleTimeString()}`;
                } else {
                    throw new Error(result.error || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('åŠ è½½è¯·æ±‚å¤±è´¥:', error);
                
                let errorMessage = 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                if (error.name === 'AbortError') {
                    errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.message) {
                    errorMessage = `åŠ è½½å¤±è´¥: ${error.message}`;
                }
                
                document.getElementById('statusText').textContent = errorMessage;
                showToast(errorMessage);
                
                // æ˜¾ç¤ºç©ºçŠ¶æ€
                const listContainer = document.getElementById('requestList');
                const emptyState = document.getElementById('emptyState');
                listContainer.innerHTML = '';
                emptyState.style.display = 'block';
                
            } finally {
                isLoading = false;
            }
        }
        
        // å¼ºåˆ¶åŒæ­¥å¤„ç†è®°å½•
        async function forceSync() {
            if (isLoading) return;
            
            isLoading = true;
            document.getElementById('statusText').textContent = 'æ­£åœ¨å¼ºåˆ¶åŒæ­¥...';
            
            // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000); // 20ç§’è¶…æ—¶
            
            try {
                const response = await fetch('/api/sync', {
                    method: 'POST',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayRequests(result.data);
                    document.getElementById('statusText').textContent = 
                        `å¼ºåˆ¶åŒæ­¥æˆåŠŸï¼å…± ${result.data.length} ä¸ªå¾…å¤„ç†è¯·æ±‚ï¼Œå·²å¤„ç† ${result.processed_count} ä¸ª | ${new Date().toLocaleTimeString()}`;
                    showToast(`ğŸ”„ åŒæ­¥æˆåŠŸ: ${result.message}`);
                } else {
                    throw new Error(result.error || 'åŒæ­¥å¤±è´¥');
                }
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('å¼ºåˆ¶åŒæ­¥å¤±è´¥:', error);
                
                let errorMessage = 'åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                if (error.name === 'AbortError') {
                    errorMessage = 'åŒæ­¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.message) {
                    errorMessage = `åŒæ­¥å¤±è´¥: ${error.message}`;
                }
                
                document.getElementById('statusText').textContent = errorMessage;
                showToast(errorMessage);
                
                // æ˜¾ç¤ºç©ºçŠ¶æ€
                const listContainer = document.getElementById('requestList');
                const emptyState = document.getElementById('emptyState');
                listContainer.innerHTML = '';
                emptyState.style.display = 'block';
                
            } finally {
                isLoading = false;
            }
        }
        
        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        async function showDebugInfo() {
            if (isLoading) return;
            
            try {
                const response = await fetch('/api/debug');
                const result = await response.json();
                
                if (result.success) {
                    const info = result.debug_info;
                    let debugMsg = `ğŸ”§ ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯\n\n`;
                    debugMsg += `â° å½“å‰æ—¶é—´: ${info.formatted_time}\n`;
                    debugMsg += `â±ï¸ æ—¶é—´æˆ³: ${info.timestamp}\n\n`;
                    debugMsg += `ğŸ“‹ å·²å¤„ç†è¯·æ±‚æ•°: ${info.processed_requests_count}\n`;
                    
                    if (info.processed_requests_list && info.processed_requests_list.length > 0) {
                        debugMsg += `ğŸ“ å·²å¤„ç†åˆ—è¡¨: ${info.processed_requests_list.join(', ')}\n\n`;
                    } else {
                        debugMsg += `ğŸ“ å·²å¤„ç†åˆ—è¡¨: ç©º\n\n`;
                    }
                    
                    debugMsg += `ğŸŒ Giteeä»“åº“: ${info.gitee_config.repo}\n`;
                    debugMsg += `ğŸ”‘ Tokené•¿åº¦: ${info.gitee_config.token_length}\n\n`;
                    
                    if (info.gitee_requests_folder) {
                        const folder = info.gitee_requests_folder;
                        debugMsg += `ğŸ“ è¯·æ±‚æ–‡ä»¶å¤¹çŠ¶æ€: ${folder.status}\n`;
                        if (folder.file_count !== undefined) {
                            debugMsg += `ğŸ“„ æ–‡ä»¶æ•°é‡: ${folder.file_count}\n`;
                            if (folder.files && folder.files.length > 0) {
                                debugMsg += `ğŸ“ æ–‡ä»¶åˆ—è¡¨: ${folder.files.join(', ')}\n`;
                            }
                        } else if (folder.error) {
                            debugMsg += `âŒ é”™è¯¯: ${folder.error}\n`;
                        }
                    }
                    
                    // æ˜¾ç¤ºåœ¨å¼¹çª—ä¸­
                    alert(debugMsg);
                    
                    // åŒæ—¶åœ¨æ§åˆ¶å°è¾“å‡ºè¯¦ç»†ä¿¡æ¯
                    console.log('ğŸ”§ è°ƒè¯•ä¿¡æ¯:', result.debug_info);
                } else {
                    showToast(`è°ƒè¯•ä¿¡æ¯è·å–å¤±è´¥: ${result.error}`);
                }
            } catch (error) {
                console.error('è·å–è°ƒè¯•ä¿¡æ¯å¤±è´¥:', error);
                showToast('è·å–è°ƒè¯•ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            }
        }
        
        // æ˜¾ç¤ºè¯·æ±‚åˆ—è¡¨
        function displayRequests(requests) {
            const listContainer = document.getElementById('requestList');
            const emptyState = document.getElementById('emptyState');
            
            if (requests.length === 0) {
                listContainer.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            listContainer.innerHTML = requests.map(req => `
                <div class="request-card">
                    <div class="request-header">
                        <div class="machine-code">${req.machine_code}</div>
                        <div class="time-badge">${formatTime(req.request_time)}</div>
                    </div>
                    
                    <div class="request-info">
                        <div class="info-row">
                            <span class="info-label">è®¡ç®—æœº</span>
                            <span class="info-value">${req.computer_name || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç”¨æˆ·</span>
                            <span class="info-value">${req.username || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç³»ç»Ÿ</span>
                            <span class="info-value">${req.system || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è¯·æ±‚æ—¶é—´</span>
                            <span class="info-value">${req.request_time}</span>
                        </div>
                    </div>
                    
                    <div class="expire-selector" id="expireSelector_${req.machine_code}">
                        <button class="expire-option active" onclick="setExpireTime('${req.machine_code}', 168)">7å¤©</button>
                        <button class="expire-option" onclick="setExpireTime('${req.machine_code}', 720)">30å¤©</button>
                        <button class="expire-option" onclick="setExpireTime('${req.machine_code}', 2160)">90å¤©</button>
                        <button class="expire-option" onclick="setExpireTime('${req.machine_code}', 8760)">1å¹´</button>
                        <button class="expire-option" onclick="setExpireTime('${req.machine_code}', 87600)">æ°¸ä¹…</button>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-approve" 
                                onclick="approveRequest('${req.machine_code}')"
                                id="approveBtn_${req.machine_code}">
                            âœ… æ‰¹å‡†æˆæƒ
                        </button>
                        <button class="btn btn-reject" 
                                onclick="rejectRequest('${req.machine_code}')"
                                id="rejectBtn_${req.machine_code}">
                            âŒ æ‹’ç»æˆæƒ
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // è®¾ç½®åˆ°æœŸæ—¶é—´
        function setExpireTime(machineCode, hours) {
            const selector = document.getElementById(`expireSelector_${machineCode}`);
            const options = selector.querySelectorAll('.expire-option');
            
            options.forEach(option => {
                option.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            // å­˜å‚¨é€‰æ‹©çš„æ—¶é—´ï¼ˆå¯ä»¥ç”¨Mapå­˜å‚¨æ¯ä¸ªè¯·æ±‚çš„é€‰æ‹©ï¼‰
            if (!window.expireSelections) {
                window.expireSelections = new Map();
            }
            window.expireSelections.set(machineCode, hours);
        }
        
        // æ‰¹å‡†æˆæƒ
        async function approveRequest(machineCode) {
            const approveBtn = document.getElementById(`approveBtn_${machineCode}`);
            const rejectBtn = document.getElementById(`rejectBtn_${machineCode}`);
            
            if (approveBtn.disabled) return;
            
            // è·å–é€‰æ‹©çš„åˆ°æœŸæ—¶é—´
            const expireHours = window.expireSelections?.get(machineCode) || 168; // é»˜è®¤7å¤©
            
            // è®¾ç½®æŒ‰é’®çŠ¶æ€
            approveBtn.disabled = true;
            rejectBtn.disabled = true;
            approveBtn.classList.add('loading');
            const originalText = approveBtn.textContent;
            approveBtn.textContent = '';
            
            // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶
            
            try {
                const response = await fetch('/api/approve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        machine_code: machineCode,
                        expire_hours: expireHours
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`âœ… æˆæƒæˆåŠŸ: ${result.message}`);
                    
                    // ç«‹å³ç§»é™¤å½“å‰è¯·æ±‚å¡ç‰‡
                    const requestCard = approveBtn.closest('.request-card');
                    if (requestCard) {
                        requestCard.style.transition = 'all 0.3s ease';
                        requestCard.style.opacity = '0';
                        requestCard.style.transform = 'scale(0.95) translateY(-20px)';
                        
                        // åŠ¨ç”»å®Œæˆåç§»é™¤å…ƒç´ 
                        setTimeout(() => {
                            requestCard.remove();
                            
                            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–è¯·æ±‚å¡ç‰‡
                            const remainingCards = document.querySelectorAll('.request-card');
                            if (remainingCards.length === 0) {
                                // æ²¡æœ‰å…¶ä»–è¯·æ±‚äº†ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                                const emptyState = document.getElementById('emptyState');
                                emptyState.style.display = 'block';
                            }
                        }, 300);
                    }
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    const currentCount = document.querySelectorAll('.request-card').length - 1; // -1 å› ä¸ºå³å°†ç§»é™¤ä¸€ä¸ª
                    document.getElementById('statusText').textContent = 
                        `å¤„ç†æˆåŠŸï¼å‰©ä½™ ${currentCount} ä¸ªå¾…å¤„ç†è¯·æ±‚ | ${new Date().toLocaleTimeString()}`;
                    
                    // 1ç§’ååˆ·æ–°åˆ—è¡¨ï¼ˆé˜²æ­¢æœ‰æ–°è¯·æ±‚ï¼‰
                    setTimeout(() => {
                        loadRequests();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('æ‰¹å‡†æˆæƒå¤±è´¥:', error);
                
                let errorMessage = 'æ‰¹å‡†å¤±è´¥';
                if (error.name === 'AbortError') {
                    errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.message) {
                    errorMessage = `æ‰¹å‡†å¤±è´¥: ${error.message}`;
                }
                
                showToast(errorMessage);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                restoreButtonState(approveBtn, rejectBtn, originalText);
            }
        }
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
        function restoreButtonState(approveBtn, rejectBtn, originalText) {
            try {
                if (approveBtn) {
                    approveBtn.disabled = false;
                    approveBtn.classList.remove('loading');
                    approveBtn.textContent = originalText || 'âœ… æ‰¹å‡†æˆæƒ';
                }
                if (rejectBtn) {
                    rejectBtn.disabled = false;
                }
            } catch (error) {
                console.error('æ¢å¤æŒ‰é’®çŠ¶æ€å¤±è´¥:', error);
                // å¼ºåˆ¶åˆ·æ–°é¡µé¢ä½œä¸ºåå¤‡æ–¹æ¡ˆ
                setTimeout(() => window.location.reload(), 1000);
            }
        }
        
        // æ‹’ç»æˆæƒ
        async function rejectRequest(machineCode) {
            const approveBtn = document.getElementById(`approveBtn_${machineCode}`);
            const rejectBtn = document.getElementById(`rejectBtn_${machineCode}`);
            
            if (rejectBtn.disabled) return;
            
            if (!confirm('ç¡®å®šè¦æ‹’ç»è¿™ä¸ªæˆæƒè¯·æ±‚å—ï¼Ÿ')) {
                return;
            }
            
            // è®¾ç½®æŒ‰é’®çŠ¶æ€
            approveBtn.disabled = true;
            rejectBtn.disabled = true;
            rejectBtn.classList.add('loading');
            const originalText = rejectBtn.textContent;
            rejectBtn.textContent = '';
            
            // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶
            
            try {
                const response = await fetch('/api/reject', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        machine_code: machineCode,
                        reason: 'æˆæƒè¯·æ±‚è¢«ç§»åŠ¨ç«¯ç®¡ç†å‘˜æ‹’ç»'
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`âŒ æ‹’ç»æˆåŠŸ: ${result.message}`);
                    
                    // ç«‹å³ç§»é™¤å½“å‰è¯·æ±‚å¡ç‰‡
                    const requestCard = rejectBtn.closest('.request-card');
                    if (requestCard) {
                        requestCard.style.transition = 'all 0.3s ease';
                        requestCard.style.opacity = '0';
                        requestCard.style.transform = 'scale(0.95) translateY(-20px)';
                        
                        // åŠ¨ç”»å®Œæˆåç§»é™¤å…ƒç´ 
                        setTimeout(() => {
                            requestCard.remove();
                            
                            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–è¯·æ±‚å¡ç‰‡
                            const remainingCards = document.querySelectorAll('.request-card');
                            if (remainingCards.length === 0) {
                                // æ²¡æœ‰å…¶ä»–è¯·æ±‚äº†ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                                const emptyState = document.getElementById('emptyState');
                                emptyState.style.display = 'block';
                            }
                        }, 300);
                    }
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    const currentCount = document.querySelectorAll('.request-card').length - 1; // -1 å› ä¸ºå³å°†ç§»é™¤ä¸€ä¸ª
                    document.getElementById('statusText').textContent = 
                        `å¤„ç†æˆåŠŸï¼å‰©ä½™ ${currentCount} ä¸ªå¾…å¤„ç†è¯·æ±‚ | ${new Date().toLocaleTimeString()}`;
                    
                    // 1ç§’ååˆ·æ–°åˆ—è¡¨ï¼ˆé˜²æ­¢æœ‰æ–°è¯·æ±‚ï¼‰
                    setTimeout(() => {
                        loadRequests();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('æ‹’ç»æˆæƒå¤±è´¥:', error);
                
                let errorMessage = 'æ‹’ç»å¤±è´¥';
                if (error.name === 'AbortError') {
                    errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.message) {
                    errorMessage = `æ‹’ç»å¤±è´¥: ${error.message}`;
                }
                
                showToast(errorMessage);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                restoreButtonState(rejectBtn, approveBtn, originalText);
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadRequests();
            
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(loadRequests, 30000);
            
            // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    loadRequests();
                }
            });
        });
        
        // æ³¨å†ŒService Worker (PWAæ”¯æŒ)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(function(error) {
                console.log('ServiceWorkeræ³¨å†Œå¤±è´¥:', error);
            });
        }
    </script>
</body>
</html>